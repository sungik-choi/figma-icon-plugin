<h2>Bezier Figma Plugin</h2>
<button id="extract">Extract Icon</button>
<button id="cancel">Cancel</button>
<script>

document.getElementById('extract').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'extract' } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

onmessage = async ({ data: { pluginMessage: { type, payload } }}) => {
  if (type === 'fetchSvg') {
    const init = {
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Token': payload.token
      }
    }

    const svgs = await fetch(payload.url, init)
      .then(response => response.json())
      .then(({ images }) => Promise.all(
        payload.nodes.map(({ id, name }) => fetch(images[id])
          .then(response => response.text())
          .then(svg => ({ name, svg }))
      )))

    parent.postMessage({ pluginMessage: { type: 'fetchSvgSuccess', payload: svgs } }, '*')
  }
}

</script>
