<h2>Bezier Figma Plugin</h2>
<button id="extract">Extract Icon</button>
<button id="cancel">Cancel</button>
<script type="module">
import { Octokit, App } from "https://cdn.skypack.dev/octokit";

document.getElementById('extract').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'extract' } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

const octokit = new Octokit({
  auth: ''
})

onmessage = async ({ data: { pluginMessage: { type, payload } }}) => {
  if (type === 'fetchSvg') {
    const response = await fetch(`https://api.figma.com/v1/images/${payload.fileKey}?ids=${payload.ids}&format=svg`, {
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Token': payload.token
      }
    })
  
    const { images } = await response.json()

    const svgs = await Promise.all(
      payload.nodes.map(({ id, name }) => fetch(images[id])
        .then(response => response.text())
        .then(svg => ({ name, svg })))
    )

    // Create a blob of the svgs
    const svgBlobs = await Promise.all(
      svgs.map(({ name, svg }) => octokit.request('POST /repos/{owner}/{repo}/git/blobs', {
        owner: 'sungik-choi',
        repo: 'figma-icon-plugin',
        content: svg,
        encoding: 'utf-8'
      }).then(({ data }) => ({ name, sha: data.sha })))
    )

    // Get the sha of the current default branch
    const { data: [ref] } = await octokit.request('GET /repos/{owner}/{repo}/git/matching-refs/{ref}', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      ref: 'heads/main',
    })

    const headCommitSha = ref.object.sha

    // Get the head commit of the current default branch
    const { data: headCommit } = await octokit.request('GET /repos/{owner}/{repo}/git/commits/{commit_sha}', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      commit_sha: headCommitSha,
    })

    // Get the tree of the head commit
    const { data: { tree: headTree } } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      tree_sha: headCommit.tree.sha
    })

    // Create a new Key value pair of git tree
    const svgTreeObj = svgBlobs.reduce((acc, { name, sha }) => {
      const path = `${name}.svg`
      return { ...acc, [path]: { path, mode: '100644', type: 'blob', sha } }
    }, {})

    const EXISTED_SVG_DIR_NAME = 'test'

    // Find the root of the svg blobs tree sha
    const { sha: svgBlobsTreeSha } = headTree.find(({ path }) => path === EXISTED_SVG_DIR_NAME)

    // Get the tree of the the svg blobs tree
    const { data: { tree: svgBlobsTree } } = await octokit.request('GET /repos/{owner}/{repo}/git/trees/{tree_sha}', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      tree_sha: svgBlobsTreeSha,
    })

    // Merge tree
    const newTree = [
      ...headTree.filter(({ path }) => path !== EXISTED_SVG_DIR_NAME),
      ...svgBlobsTree.map((blob) => {
        const overridedBlob = svgTreeObj[blob.path]
        if (overridedBlob) {
          delete svgTreeObj[blob.path]
          return { ...blob, ...overridedBlob }
        }
        return blob
      }),
      ...Object.values(svgTreeObj)
    ]

    // Generate new tree with the new svg assets
    const { data: gitTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      tree: newTree,
    })

    const now = new Date()

    // Create a new commit object with the new tree
    const { data: commit } = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      message: 'feat(icons): update icons',
      author: {
        name: 'sungik-choi',
        email: 'sungik.dev@gmail.com',
        date: now.toISOString(),
      },
      parents: [headCommitSha],
      tree: gitTree.sha,
    })

    const newBranchName = `update-icons-${now.valueOf()}`
    const newRef = `refs/heads/${newBranchName}`

    // Create a new branch with the same sha
    const { data } = await octokit.request('POST /repos/{owner}/{repo}/git/refs', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      ref: newRef,
      sha: commit.sha,
    })

    // Create Pull Request
    await octokit.request('POST /repos/{owner}/{repo}/pulls', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      title: 'ðŸ‘‹ Update Icon!',
      body: 'Please pull these awesome changes in!',
      head: newBranchName,
      base: 'main',
    })
  }
}

</script>
