<h2>Bezier Figma Plugin</h2>
<button id="extract">Extract Icon</button>
<button id="cancel">Cancel</button>
<script type="module">
import { Octokit, App } from "https://cdn.skypack.dev/octokit";

document.getElementById('extract').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'extract' } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

const octokit = new Octokit({
  auth: '',
})

onmessage = async ({ data: { pluginMessage: { type, payload } }}) => {
  if (type === 'fetchSvg') {
    const response = await fetch(`https://api.figma.com/v1/images/${payload.fileKey}?ids=${payload.ids}&format=svg`, {
      headers: {
        'Content-Type': 'application/json',
        'X-Figma-Token': payload.token
      }
    })
  
    const { images } = await response.json()

    const svgs = await Promise.all(
      payload.nodes.map(({ id, name }) => fetch(images[id])
        .then(response => response.text())
        .then(svg => ({ name, svg })))
    )

    const tree = svgs.map(({ name, svg }) => ({
      path: `test/${name}.svg`,
      mode: '100644',
      type: 'blob',
      content: svg,
    }))

    const { data: gitTree } = await octokit.request('POST /repos/{owner}/{repo}/git/trees', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      tree,
    })

    const commit = await octokit.request('POST /repos/{owner}/{repo}/git/commits', {
      owner: 'sungik-choi',
      repo: 'figma-icon-plugin',
      message: 'ðŸ“¦ Extracted Icon from Figma',
      author: {
        name: 'Octocat',
        email: 'octocat@github.com',
        date: new Date().toISOString(),
      },
      tree: gitTree.sha,
    })
  }
}

</script>
